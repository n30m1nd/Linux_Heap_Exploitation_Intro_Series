#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define WORD_SIZE ((size_t)-1 > 0xffffffffUL ? 8 : 4)
#define SIZEOFNORMALCHUNK 0x100-WORD_SIZE
#define SIZEOFFASTCHUNK 0x60-WORD_SIZE

void print_bytes(char *mempos, size_t size)
{
	int i = 0;
	while(i < size)
		printf("%02x", *(mempos + i++));
	printf("\n");
		
}

int main()
{
	char *A, *B, *C;
	printf("\n[+] malloc A(0x%x) \n", SIZEOFFASTCHUNK);
	A = malloc(SIZEOFFASTCHUNK);
	printf("A at %p\n", A);
	snprintf(A, SIZEOFFASTCHUNK, "This is A's contents. I would like to say something but"
					" there's not much space in 0x60 bytes...");
	printf("A contains: [%s]\n", A);
	printf("[+] Contents of A in hex: ");
	print_bytes(A, SIZEOFFASTCHUNK);

	printf("\n[+] malloc C(0x%x) \n", SIZEOFFASTCHUNK);
	C = malloc(SIZEOFFASTCHUNK);
	printf("C at %p\n", C);
	printf("\n[+] free(C)\n");
	free(C);

	printf("\n[+] free(A)\n");
	free(A);

	printf("\n[+] malloc B(0x%x) \n", SIZEOFFASTCHUNK);
	B = malloc(SIZEOFFASTCHUNK);
	printf("B %p\n", B);

	snprintf(B, SIZEOFFASTCHUNK, "This is B's contents. I would like to say something but"
					" there's not much space in 0x60 bytes...");

	printf("\n[+] Double free()'ing A\n");
	free(A);

	printf("[*} Now pay attention to the contents of B\n");

	printf("B is still valid in the code but under the hood\n\
		it is free for the allocator... B contents [%s]\n", B); 

	printf("[+] Contents of B in hex: ");
	print_bytes(B, SIZEOFFASTCHUNK);

	printf("[+] We leaked C-0x10 through A's FD and BK which"
	" can be accessed through B's variable\n");
	printf("[+] A->FD = C-0x10 = %p\n", *(void **)&B[0]);


	return 0;
}
