#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define WORD_SIZE ((size_t)-1 > 0xffffffffUL ? 8 : 4)
#define SIZEOFNORMALCHUNK 0x100-WORD_SIZE
#define SIZEOFFASTCHUNK 0x60-WORD_SIZE

void print_bytes(char *mempos, size_t size)
{
	int i = 0;
	while(i < size)
		printf("%02x", mempos[i++]);
	printf("\n");
		
}

int main()
{
	char *A, *B;
	printf("\n[+] malloc A(0x%x) \n", SIZEOFFASTCHUNK);
	A = malloc(SIZEOFFASTCHUNK);
	printf("A at %p\n", A);
	snprintf(A, SIZEOFFASTCHUNK, "This is A's contents. I would like "
	"to say something but there's not much space in 0x60 bytes...");

	printf("A contains: [%s]\n", A);
	printf("[+] Contents of A in hex: \n");
	print_bytes(A, SIZEOFFASTCHUNK);

	puts("\n[+] free(A)\n");
	free(A);

	printf("\n[+] malloc B(0x%x) \n", SIZEOFFASTCHUNK);
	B = malloc(SIZEOFFASTCHUNK);
	printf("B %p\n", B);

	printf("\n[+] Double free()'ing A\n");
	free(A);

	printf("B is still valid in the code but under the hood\n\
		it is free for the allocator... B contents [%s]\n", B); 

	printf("[+] Contents of B in hex: \n");
	print_bytes(B, SIZEOFFASTCHUNK);

	return 0;
}
